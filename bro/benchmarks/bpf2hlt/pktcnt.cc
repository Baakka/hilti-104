// $Id$

#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdarg.h>
#include <string.h>
#include <getopt.h>
#include <pcap.h>

#if 0
#include <llvm/Module.h>
#include <llvm/PassManager.h>
#include <llvm/ExecutionEngine/ExecutionEngine.h>
#include <llvm/ExecutionEngine/JIT.h>
#include <llvm/Target/TargetSelect.h>
#include <llvm/Bitcode/ReaderWriter.h>
#include <llvm/Assembly/PrintModulePass.h>
#include <llvm/Support/CommandLine.h>
#include <llvm/Support/ManagedStatic.h>
#include <llvm/Support/MemoryBuffer.h>
#include <llvm/Support/Streams.h>
#include <llvm/System/Signals.h>
#include <llvm/LLVMContext.h>
#endif

extern "C" {
#include <libhilti.h>
//#include <hilti_intern.h>
}

const char *Trace;
const char *Filter;
const char *Bitcode;
int Profile = 0;

unsigned long HdrSize = 14; // Ethernet

pcap_t* Pcap = 0;
struct bpf_program* Bpf = 0;
unsigned long PacketCounter = 0;

const char* fmt_log(const char* prefix, const char* fmt, va_list ap)
{
    const int SIZE = 32768;
    static char buffer[SIZE];
    int n = 0;

    n += snprintf(buffer + n, SIZE - n, "%s: ", prefix);
	n += vsnprintf(buffer + n, SIZE - n, fmt, ap);

    strcat(buffer + n, "\n");

    return buffer;
}

void error(const char* fmt, ...)
{
    va_list ap;
    va_start(ap, fmt);
    const char* msg = fmt_log("error", fmt, ap);
    va_end(ap);
    fputs(msg, stdout);
    exit(1);
}

extern "C" {
static int8_t (*FilterFunction)(hlt_bytes *, hlt_exception **, hlt_execution_context*);
extern int8_t bpf2hlt_filter(hlt_bytes *, hlt_exception **, hlt_execution_context*);
extern int8_t bpf2hlt_filter_noop(hlt_bytes *, hlt_exception **, hlt_execution_context*);
}


void readBitcode()
{
#if 0
    // Something's broken right now.
    std::string err;
    llvm::Module* module;

    llvm::InitializeNativeTarget();

    llvm::MemoryBuffer* buffer = llvm::MemoryBuffer::getFileOrSTDIN(Bitcode, &err);
    if ( ! buffer )
        error("cannot read bitcode file %s: %s", Bitcode, err.c_str());

    module = ParseBitcodeFile(buffer, llvm::getGlobalContext(), &err);
    if ( ! module )
        error("cannot parse bitcode file %s: %s", Bitcode, err.c_str());

    std::string e;
    llvm::ExecutionEngine* engine = llvm::ExecutionEngine::create(module, false, &e);
    if ( ! engine ) {
        fprintf(stderr, "%s\n", e.c_str());
        error("cannot create engine");
    }

    llvm::Function* func = module->getFunction("bpf2hlt_filter");
    if ( ! func )
        error("cannot get function bpf2hlt_filter");

    void* vf = engine->getPointerToFunction(func);

    FilterFunction = (int8_t (*)(hlt_bytes *, hlt_exception **, hlt_execution_context*)) vf;
#else

    FilterFunction = bpf2hlt_filter;
#endif
}

void setFilter()
{
    Bpf = new bpf_program;

    if ( pcap_compile(Pcap, Bpf, const_cast<char*>(Filter), 1, 0) < 0 )
        error("can't compile %s: %s", Filter, pcap_geterr(Pcap));
}

void pcapOpen()
{
    static char errbuf[PCAP_ERRBUF_SIZE];

    Pcap = pcap_open_offline(const_cast<char*>(Trace), errbuf);

    if ( ! Pcap )
        error("%s", errbuf);

	int dl = pcap_datalink(Pcap);
    if ( dl != DLT_EN10MB )
		error("unknown data link type 0x%x", dl);

    if ( Filter )
        setFilter();
}

bool pcapNext()
{
    struct pcap_pkthdr* hdr;
    const u_char* data;
    int result;

    result = pcap_next_ex(Pcap, &hdr, &data);

    if ( result < 0 )
        // error("no more input");
        return false;

    if ( result == 0 )
        return false;

    hlt_exception* excpt = 0;
    hlt_execution_context* ctx = hlt_global_execution_context();

    size_t len = hdr->caplen - HdrSize;
    int8_t* buffer = (int8_t*) hlt_malloc(len);
    memcpy((char *)buffer, data + HdrSize, len);

    if ( Bitcode ) {
        hlt_bytes* b = hlt_bytes_new_from_data(buffer, len, &excpt, ctx);
        if ( ! (*FilterFunction)(b, &excpt, ctx) )
            return true;

        GC_DTOR(b, hlt_bytes);
    }
    else {
        hlt_free(buffer);
        if ( ! pcap_offline_filter(Bpf, hdr, data) )
            return true;
    }

    ++PacketCounter;

    return true;
}

void pcapClose()
{
    pcap_close(Pcap);
}

void usage()
{
    printf("pktcnt [Options] <input file>\n"
           "\n"
           "  -r| --readfile <trace>         Trace file to read\n"
           "  -f| --filter <filter>          BPF filter for filtering with libpcap\n"
           "  -b| --bitcode <secs>           Bitcode file generated by bpf2hlt + hilti-build\n"
           "  -P| --profile                  Enable HILTI profiling\n"
           "\n");

    exit(1);
}

static struct option long_options[] = {
    {"filter", required_argument, 0, 'f'},
    {"bitcode", required_argument, 0, 'b'},
    {"readfile", required_argument, 0, 't'},
    {"profile", required_argument, 0, 'P'},
    {0, 0, 0, 0}
};

int main(int argc, char **argv)
{
    hlt_init();

    while (1) {
        char c = getopt_long (argc, argv, "f:b:r:P", long_options, 0);

        if ( c == -1 )
            break;

        switch ( c ) {
          case 'f':
            Filter = optarg;
            break;

          case 'b':
            Bitcode = optarg;
            break;

          case 'r':
            Trace = optarg;
            break;

          case 'P':
            Profile = 1;
            break;

          default:
            usage();
        }
    }

    if ( optind != argc )
        usage();

    if ( ! Trace )
        error("need -r");

    if ( ! (Filter || Bitcode) )
        error("need either -f or -b");

    if ( (Filter && Bitcode) )
        error("can only have one of -f or -b");

    if ( Bitcode )
        readBitcode();

    hlt_exception* excpt = 0;
    hlt_string profiler_tag = hlt_string_from_asciiz("pktcnt-total", &excpt, hlt_global_execution_context());

    if ( Profile ) {
        fprintf(stderr, "Enabling profiling ...\n");
        hlt_config cfg = *hlt_config_get();
        cfg.profiling = 1;
        hlt_config_set(&cfg);
    }

    pcapOpen();

    if ( Profile ) {
        hlt_exception* excpt = 0;
        hlt_profiler_start(profiler_tag, Hilti_ProfileStyle_Standard, 0, 0, &excpt, hlt_global_execution_context());
    }

    PacketCounter = 0;

    while ( pcapNext() );

    if ( Profile ) {
        hlt_exception* excpt = 0;
        hlt_profiler_stop(profiler_tag, &excpt, hlt_global_execution_context());
    }

    pcapClose();

    fprintf(stdout, "packets %lu\n", PacketCounter);

    return 0;
    }



