
#include <locale.h>
#include <stdio.h>
#include <stdlib.h>

#include "types.h"
#include "config.h"
#include "debug.h"
#include "globals.h"
#include "hook.h"
#include "threading.h"
#include "profiler.h"

// This is generated by the HILTI linker to initialize all the modules.
extern __hlt_modules_init(hlt_exception** excpt, hlt_execution_context* ctx);

void hlt_init()
{
    // Initialize locale.
    if ( ! setlocale(LC_CTYPE, "") ) {
        fputs("libhilti: cannot set locale", stderr);
        exit(1);
    }

    __hlt_config_init();
    __hlt_debug_init();
    __hlt_files_init();
    __hlt_cmd_queue_init();
//  __hlt_profiling_init();
    __hlt_global_state_init();
    __hlt_hooks_init();
    __hlt_threading_init();
    __hlt_profiler_init();

    hlt_execution_context* ctx = hlt_global_execution_context();
    hlt_exception* excpt = 0;
    __hlt_modules_init(&excpt, ctx);

    if ( excpt )
        __hlt_exception_print_uncaught_abort(excpt, ctx);
}

void hlt_done()
{
    hlt_exception* excpt = 0;

    __hlt_profiler_done();
    __hlt_threading_done(&excpt);

    if ( excpt )
        hlt_exception_print_uncaught(excpt, hlt_global_execution_context());

    __hlt_hooks_done();
    __hlt_global_state_done();
//  __hlt_profiling_done();
    __hlt_cmd_queue_done();
    __hlt_files_done();
    __hlt_debug_done();
    __hlt_config_done();
}

